version: "3.8"

services:
  chroma:
    image: ghcr.io/chroma-core/chroma:latest
    environment:
      - IS_PERSISTENT=true
    volumes:
      - chroma_data:/data
    ports:
      - "8001:8000"
    networks:
      - internal
    deploy:
      restart_policy:
        condition: any

  ingester:
    image: ghcr.io/amateuracademic/wiki-rag-ingester:${IMAGE_TAG:-latest}
    depends_on:
      - chroma
    environment:
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
      - NEBIUS_API_KEY=${NEBIUS_API_KEY}
    volumes:
      - /root/docker_data/wiki:/app/data/markdown
      - ingestion_state:/app/state
    networks:
      - internal
    deploy:
      restart_policy:
        condition: any

  egester:
    image: ghcr.io/amateuracademic/wiki-rag-egester:${IMAGE_TAG:-latest}
    volumes:
      - /root/docker_data/wiki:/app/data/markdown
      - ingestion_state:/app/state
    ports:
      - "8002:8001"
    networks:
      - internal
    deploy:
      restart_policy:
        condition: any

  api:
    image: ghcr.io/amateuracademic/wiki-rag-api:${IMAGE_TAG:-latest}
    depends_on:
      - chroma
    environment:
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
      - NEBIUS_API_KEY=${NEBIUS_API_KEY}
      - WIKI_BASE_URL=${WIKI_BASE_URL}
    ports:
      - "${API_PORT:-8000}:8000"
    networks:
      - proxy
      - internal
    deploy:
      restart_policy:
        condition: any

volumes:
  chroma_data:
  ingestion_state:

networks:
  proxy:
    external: true
  internal:
    driver: overlay
    attachable: true
