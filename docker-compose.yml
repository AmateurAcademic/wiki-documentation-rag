version: '3.8'

services:
  chroma:
    image: ghcr.io/chroma-core/chroma:latest
    environment:
      - IS_PERSISTENT=true
    volumes:
      - chroma_data:/data
    ports:
      - "8001:8000"
    networks:
      - internal
    deploy:
      restart_policy:
        condition: any

  ingester:
    image: ghcr.io/amateuracademic/wiki-rag-ingester:${GIT_BRANCH:-main}
    build:
      context: ./wiki_tools/ingester
      dockerfile: Dockerfile
    depends_on:
      - chroma
    environment:
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
      - NEBIUS_API_KEY=${NEBIUS_API_KEY}
    volumes:
      - /root/docker_data/wiki:/app/data/markdown
      - ingester_state:/app/state
    networks:
      - internal
    deploy:
      restart_policy:
        condition: any

  egester:
    image: ghcr.io/amateuracademic/wiki-rag-egester:${GIT_BRANCH:-main}
    build:
      context: ./wiki_tools/egester
      dockerfile: Dockerfile
    environment:
      - DATA_DIR=/app/data
    volumes:
      - /root/docker_data/wiki:/app/data/markdown
      - egester_state:/app/state
    networks:
      - internal
      - egester-network
    ports:
      - "8001:8001"  # For local testing
    deploy:
      restart_policy:
        condition: any

  api:
    image: ghcr.io/amateuracademic/wiki-rag-api:latest
    depends_on:
      - chroma
    environment:
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
      - NEBIUS_API_KEY=${NEBIUS_API_KEY}
      - WIKI_BASE_URL=${WIKI_BASE_URL}
    ports:
      - "${API_PORT:-8000}:8000"
    networks:
      - proxy      # For external access via NPM
      - internal   # For chroma communication
      - egester-network  # For egester communication
    deploy:
      restart_policy:
        condition: any

volumes:
  chroma_data:
  ingester_state:
  egester_state:

networks:
  proxy:
    external: true  # For Nginx Proxy Manager
  internal:
    driver: overlay
    attachable: true
  egester-network:
    driver: bridge
